<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci칩n - Firmar PDFs</title>
    <link rel="stylesheet" href="styles.css">
    <script src="config.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Otras librer칤as -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <!-- SheetJS para lectura/escritura de Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        // Configurar worker de PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
        }
    </script>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>Panel de Administraci칩n - Firma de Documentos</h1>
            <div style="margin-top: 10px; display: flex; gap: 15px; justify-content: center;">

            </div>
        </div>

        <!-- Grid de dos columnas para mejor organizaci칩n -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
            
            <!-- Columna Izquierda -->
            <div style="display: flex; flex-direction: column; gap: 20px;">
                
                <!-- Secci칩n de b칰squeda de firmas -->
                <div class="card">
                    <h2>Buscar Firma Registrada</h2>
                    <p style="margin-bottom: 20px; color: #666; font-size: 0.95rem;">Busca firmas por nombre o CURP/RFC</p>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="searchInput" placeholder="Buscar por nombre o CURP..." 
                               style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                        <button id="searchBtn" class="btn btn-primary" style="white-space: nowrap; width: auto; padding: 0 15px;">
                            Buscar
                        </button>
                    </div>

                    <div id="searchResults" style="display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Resultados de b칰squeda:</h3>
                        <div id="searchResultsList" style="max-height: 350px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Estad칤sticas -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">Estad칤sticas del Sistema</h3>
                    <div class="stats-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card" style="text-align: center; padding: 20px; background: #fef3c7; border-radius: 8px; border: 2px solid #f59e0b;">
                            <div class="stat-value" id="todaySignatures" style="font-size: 2.5rem; font-weight: bold; color: #d97706;">0</div>
                            <div class="stat-label" style="color: #64748b; margin-top: 5px;">Firmas Hoy</div>
                            <div id="todayDate" style="font-size: 0.75rem; color: #9ca3af; margin-top: 5px;"></div>
                        </div>
                        <div class="stat-card" style="text-align: center; padding: 20px; background: #f0f9ff; border-radius: 8px; border: 2px solid #3b82f6;">
                            <div class="stat-value" id="totalSignatures" style="font-size: 2.5rem; font-weight: bold; color: #1e40af;">0</div>
                            <div class="stat-label" style="color: #64748b; margin-top: 5px;">Total Firmas</div>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 2px solid #10b981; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <div id="repSignatureStatus" style="font-size: 1.8rem; font-weight: bold; color: #059669;">N/A</div>
                            <div style="color: #64748b; font-weight: 500;">Firma del Representante</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button id="viewTodaySignaturesBtn" class="btn btn-primary" style="flex: 1; font-size: 0.95rem;">
                            Ver Firmas de Hoy
                        </button>
                        <button id="viewSignaturesBtn" class="btn btn-secondary" style="flex: 1; font-size: 0.95rem;">
                            Ver Todas
                        </button>
                    </div>
                    <button id="configRepBtn" class="btn btn-secondary" style="width: 100%;">
                        Configurar Firma del Representante
                    </button>
                </div>

                <!-- Secci칩n de Cotejo de Asistencia -->
                <div class="card">
                    <h3 style="margin-bottom: 15px;">Control de Asistencia</h3>
                    <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 15px;">
                        Carga el archivo Excel con la lista de personas esperadas
                    </p>
                    
                    <input type="file" id="attendanceExcelFile" accept=".xlsx,.xls" style="display: none;">
                    
                    <!-- Selector de Fecha -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem;">
                            游늰 Selecciona la fecha:
                        </label>
                        <input type="date" id="attendanceDatePicker" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem;" />
                    </div>
                    
                    <button id="loadAttendanceBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                        游늭 Cargar Lista Excel
                    </button>
                    
                    <!-- Selector de hojas (se muestra despu칠s de cargar el Excel) -->
                    <div id="sheetSelector" style="display: none; margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 8px; border: 1px solid #f59e0b;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #92400e;">
                            游늶 Selecciona la hoja:
                        </label>
                        <select id="sheetSelect" style="width: 100%; padding: 10px; border: 2px solid #f59e0b; border-radius: 6px; font-size: 0.95rem; margin-bottom: 10px;">
                            <!-- Opciones se cargar치n din치micamente -->
                        </select>
                        <button id="confirmSheetBtn" class="btn btn-primary" style="width: 100%;">
                            Cargar Hoja Seleccionada
                        </button>
                    </div>
                    
                    <div id="attendanceInfo" style="display: none; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #3b82f6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="color: #1e40af; font-weight: 600;">游늶 Lista cargada:</span>
                            <span id="attendanceTotal" style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9rem; font-weight: bold;">0</span>
                        </div>
                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 8px;">
                            <span id="attendancePresent" style="color: #10b981; font-weight: 600;">0 Firmaron</span> | 
                            <span id="attendanceMissing" style="color: #ef4444; font-weight: 600;">0 Faltan</span> | 
                            <span id="attendancePrinted" style="color: #8b5cf6; font-weight: 600;">0 Impresas</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 5px;">
                            <strong>Fecha:</strong> <span id="loadedAttendanceDate" style="color: #3b82f6;">-</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #64748b;">
                            <strong>Hoja:</strong> <span id="loadedSheetName" style="color: #3b82f6;">-</span>
                        </div>
                    </div>
                    
                    <button id="viewAttendanceBtn" class="btn btn-secondary" style="width: 100%; margin-top: 10px; display: none;">
                        Ver Tabla de Cotejo
                    </button>
                </div>
            </div>

            <!-- Columna Derecha -->
            <div style="display: flex; flex-direction: column; gap: 20px;">
                
                <!-- Secci칩n de firmado -->
                <div class="card">
                    <h2>Firmar PDF</h2>
                    
                    <div class="form-group" style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #374151;">
                            1. Selecciona los documentos (PDF o Im치genes):
                        </label>
                        <input type="file" id="pdfFile" accept=".pdf,.jpg,.jpeg,.png,image/*" multiple 
                               style="width: 100%; padding: 12px; border: 2px dashed #cbd5e1; border-radius: 8px; cursor: pointer; background: #f8fafc;">
                    </div>

                    <!-- Cola de archivos -->
                    <div id="filesQueueSection" style="display: none; margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                            <span>Archivos en cola</span>
                            <span id="queueCount" style="background: #3b82f6; color: white; padding: 2px 12px; border-radius: 12px; font-size: 0.9rem;">0</span>
                        </h3>
                        <div id="filesQueue" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; max-height: 350px; overflow-y: auto;">
                            <!-- Los archivos se mostrar치n aqu칤 -->
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button id="processAllBtn" class="btn btn-primary" style="flex: 1; font-size: 1.05rem; padding: 14px;">
                                Procesar Todos los Archivos
                            </button>
                            <button id="clearQueueBtn" class="btn btn-secondary" style="padding: 14px 20px;" title="Limpiar cola y agregar m치s archivos">
                                Limpiar Cola
                            </button>
                        </div>
                    </div>

                    <div id="scanningSection" style="display: none; margin-top: 20px;">
                        <div style="background: #dbeafe; border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; text-align: center;">
                            <h3 style="color: #1e40af; margin-bottom: 15px;">Escaneando PDF...</h3>
                            <div style="margin: 20px 0;">
                                <div style="width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden;">
                                    <div id="scanProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); transition: width 0.3s;"></div>
                                </div>
                                <p id="scanStatus" style="margin-top: 10px; color: #1e40af; font-size: 0.95rem;">Convirtiendo PDF a imagen...</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="personDataSection" style="display: none; margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h3 style="margin-bottom: 15px; color: #1f2937;">Datos detectados:</h3>
                        <label for="personName" style="display: block; margin-bottom: 5px; font-weight: 500; color: #4b5563;">Nombre Completo:</label>
                        <input type="text" id="personName" placeholder="Detectado autom치ticamente o edita aqu칤" class="form-control" style="margin-bottom: 15px;">
                        
                        <label for="personDoc" style="display: block; margin-bottom: 5px; font-weight: 500; color: #4b5563;">CURP/RFC:</label>
                        <input type="text" id="personDoc" placeholder="Detectado autom치ticamente o edita aqu칤" class="form-control" style="margin-bottom: 15px;">
                        
                        <button id="searchSignatureBtn" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                            Buscar Firma Manualmente
                        </button>
                        <p style="text-align: center; color: #6b7280; font-size: 0.85rem; margin-top: 8px; line-height: 1.4;">
                            El sistema ya busc칩 autom치ticamente, usa este bot칩n si necesitas buscar de nuevo
                        </p>
                    </div>

                    <div id="signatureFound" style="display: none; margin-top: 20px;">
                        <div style="border: 2px solid #10b981; border-radius: 8px; padding: 20px; background: #f0fdf4;">
                            <h3 style="color: #059669; margin-bottom: 15px; text-align: center;">Firma encontrada</h3>
                            <img id="foundSignature" style="max-width: 250px; display: block; margin: 15px auto; border: 1px solid #d1d5db; border-radius: 4px; padding: 8px; background: white;">
                            <p style="text-align: center; margin: 10px 0; font-size: 1.05rem;"><strong id="foundName"></strong></p>
                        </div>
                        
                        <button id="signPdfBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px; font-size: 1.1rem; padding: 16px;">
                            Firmar y Descargar PDF
                        </button>
                    </div>

                    <div id="noSignature" style="display: none; margin-top: 20px;">
                        <div style="background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; padding: 20px;">
                            <h3 style="color: #dc2626; margin-bottom: 10px;">Firma no encontrada</h3>
                            <p style="color: #991b1b; margin-bottom: 10px;">No se encontr칩 ninguna firma registrada para esta persona.</p>
                            <p style="margin-top: 10px; color: #7f1d1d;"><strong>Sugerencia:</strong> Verifica que la persona haya capturado su firma en la p치gina de captura.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuraci칩n firma representante (Modal/Secci칩n oculta) -->
        <div id="representantConfig" class="config-section" style="display: none; margin-top: 20px;">
            <div class="card" style="border: 2px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Firma del Representante Legal</h2>
                    <button onclick="document.getElementById('representantConfig').style.display='none'" 
                            class="btn btn-secondary" style="padding: 8px 16px;">
                        Cerrar
                    </button>
                </div>
                
                <div id="currentRepSignature" style="margin: 20px 0;"></div>
                
                <input type="file" id="repSignatureFile" accept="image/png,image/jpeg,image/jpg" style="display: none;">
                
                <div class="upload-area" id="repUploadArea" style="padding: 40px 20px; cursor: pointer;">
                    <div class="upload-content">
                        <div class="upload-icon" style="font-size: 3rem;">游늯</div>
                        <h4>Sube la imagen de la firma del representante</h4>
                        <p style="color: #64748b; margin-top: 10px;">Formatos: PNG, JPG o JPEG</p>
                    </div>
                </div>

                <div id="repSignaturePreview" style="display: none; margin: 20px 0; text-align: center;">
                    <h4>Vista Previa:</h4>
                    <img id="repPreviewImg" style="max-width: 300px; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                </div>

                <button id="saveRepBtn" class="btn btn-primary" style="width: 100%; margin-top: 15px; padding: 14px; font-size: 1.05rem;" disabled>
                    Guardar Firma del Representante
                </button>
            </div>
        </div>

        <!-- Lista de firmas registradas - Full Width -->
        <div class="card" id="signaturesListSection" style="display: none; grid-column: 1 / -1; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1.3rem;">Firmas Registradas</h3>
                <button id="closeSignaturesBtn" class="btn btn-secondary">Cerrar</button>
            </div>
            
            <div id="signaturesList" style="display: grid; gap: 15px;">
                <!-- Las firmas se cargar치n aqu칤 din치micamente -->
            </div>
            
            <div id="noSignaturesMessage" style="display: none; text-align: center; padding: 50px; background: #f3f4f6; border-radius: 8px; border: 1px solid #e5e7eb;">
                <p style="font-size: 1.3rem; color: #6b7280; margin-bottom: 10px;">No hay firmas registradas</p>
                <p style="color: #9ca3af; font-size: 0.95rem;">Las firmas aparecer치n aqu칤 cuando se capturen desde la p치gina de registro</p>
            </div>
        </div>

        <!-- Tabla de Cotejo de Asistencia - Full Width -->
        <div class="card" id="attendanceCheckSection" style="display: none; grid-column: 1 / -1; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1.3rem;">Tabla de Cotejo - Control de Asistencia</h3>
                <div style="display: flex; gap: 10px;">
                    <button id="filterAllBtn" class="btn btn-secondary" style="padding: 10px 20px;">
                        Todos
                    </button>
                    <button id="filterMissingBtn" class="btn btn-secondary" style="padding: 10px 20px; background: #ef4444; border-color: #ef4444;">
                        Solo Faltantes
                    </button>
                    <button id="exportMissingBtn" class="btn btn-primary" style="padding: 10px 20px;">
                        游닌 Exportar Faltantes
                    </button>
                    <button id="closeAttendanceBtn" class="btn btn-secondary">
                        Cerrar
                    </button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="attendanceTable" style="width: 100%; border-collapse: collapse; background: white;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #1f2937;">#</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #1f2937;">Nombre Completo</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #1f2937;">Estado</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #1f2937;">Hora de Firma</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #1f2937;">CURP</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #1f2937;">Constancia Impresa</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        <!-- Las filas se generar치n din치micamente -->
                    </tbody>
                </table>
            </div>
            
            <div id="noAttendanceMessage" style="display: none; text-align: center; padding: 50px; background: #fef3c7; border-radius: 8px; border: 1px solid #f59e0b; margin-top: 20px;">
                <p style="font-size: 1.3rem; color: #92400e; margin-bottom: 10px;">No hay lista de asistencia cargada</p>
                <p style="color: #78350f; font-size: 0.95rem;">Carga un archivo Excel con los nombres esperados para ver el cotejo</p>
            </div>
        </div>
    </div>

    <footer style="margin-top: 40px; padding: 25px; background: #f8fafc; border-top: 2px solid #e2e8f0; text-align: center;">
        <p style="margin: 0; color: #64748b; font-size: 0.95rem;">
            Sistema de Firmas Digitales - CATRA | 
            <a href="index.html" style="color: #3b82f6; text-decoration: none; font-weight: 500;">Captura de Firmas</a>
        </p>
    </footer>

    <script src="admin.js"></script>
</body>
</html>
