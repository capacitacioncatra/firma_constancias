<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Firmar PDFs</title>
    <link rel="stylesheet" href="styles.css">
    <script src="config.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Otras librer√≠as -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <!-- SheetJS para lectura/escritura de Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        // Configurar worker de PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
        }
    </script>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>Panel de Administraci√≥n - Firma de Documentos</h1>
            <div style="margin-top: 10px; display: flex; gap: 15px; justify-content: center;">

            </div>
        </div>

        <!-- Contenedor principal -->
        <div style="max-width: 1400px; margin: 0 auto; margin-top: 30px;">
            
            <!-- Fila: Control de Asistencia y Estad√≠sticas -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                
                <!-- Control de Asistencia -->
                <div class="card">
                <h2 style="margin-bottom: 15px;">Control de Asistencia</h2>
                <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 15px;">
                    Carga el archivo Excel con la lista de personas esperadas
                </p>
                
                <input type="file" id="attendanceExcelFile" accept=".xlsx,.xls" style="display: none;">
                <input type="file" id="constanciasFiles" accept=".pdf,.jpg,.jpeg,.png,image/*" multiple style="display: none;">
                
                <!-- Selector de Fecha -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem;">
                        Selecciona la fecha:
                    </label>
                    <div style="position: relative;">
                        <input type="date" id="attendanceDatePicker" style="width: 100%; max-width: 300px; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem;" />
                        <div id="dateChangeIndicator" style="display: none; margin-top: 5px; padding: 5px 10px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 4px; font-size: 0.8rem; color: #1e40af; max-width: 300px;">
                            üí° Cambia la fecha para ver otra lista del mismo Excel
                        </div>
                    </div>
                </div>
                
                <button id="loadAttendanceBtn" class="btn btn-primary" style="width: 100%; max-width: 300px; margin-bottom: 10px;">
                    Cargar Lista Excel
                </button>
                
                <!-- Selector de hojas -->
                <div id="sheetSelector" style="display: none; margin-top: 15px; padding: 15px; background: #fef3c7; border-radius: 8px; border: 1px solid #f59e0b; max-width: 500px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #92400e;">
                        üìã Selecciona la hoja:
                    </label>
                    <select id="sheetSelect" style="width: 100%; padding: 10px; border: 2px solid #f59e0b; border-radius: 6px; font-size: 0.95rem; margin-bottom: 10px;">
                    </select>
                    <button id="confirmSheetBtn" class="btn btn-primary" style="width: 100%;">
                        Cargar Hoja Seleccionada
                    </button>
                </div>
                
                <div id="attendanceInfo" style="display: none; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #3b82f6; max-width: 600px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="color: #1e40af; font-weight: 600;">üìã Lista cargada:</span>
                        <span id="attendanceTotal" style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9rem; font-weight: bold;">0</span>
                    </div>
                    <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 8px;">
                        <span id="attendancePresent" style="color: #10b981; font-weight: 600;">0 Firmaron</span> | 
                        <span id="attendanceMissing" style="color: #ef4444; font-weight: 600;">0 Faltan</span>
                    </div>
                    <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 8px;">
                        <span id="attendanceConstancias" style="color: #3b82f6; font-weight: 600;">0 Constancias</span> | 
                        <span id="attendancePrinted" style="color: #8b5cf6; font-weight: 600;">0 Impresas</span>
                    </div>
                    <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 5px;">
                        <strong>Fecha:</strong> <span id="loadedAttendanceDate" style="color: #3b82f6;">-</span>
                    </div>
                    <div style="font-size: 0.8rem; color: #64748b;">
                        <strong>Hoja:</strong> <span id="loadedSheetName" style="color: #3b82f6;">-</span>
                    </div>
                </div>
                
                <button id="viewAttendanceBtn" class="btn btn-secondary" style="width: 100%; max-width: 300px; margin-top: 10px; display: none;">
                    Ver Tabla de Cotejo
                </button>
            </div>

            <!-- Estad√≠sticas del Sistema -->
            <div class="card">
                <h3 style="margin-bottom: 20px;">Estad√≠sticas del Sistema</h3>
                <div class="stats-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card" style="text-align: center; padding: 20px; background: #fef3c7; border-radius: 8px; border: 2px solid #f59e0b;">
                        <div class="stat-value" id="todaySignatures" style="font-size: 2.5rem; font-weight: bold; color: #d97706;">0</div>
                        <div class="stat-label" style="color: #64748b; margin-top: 5px;">Firmas Hoy</div>
                        <div id="todayDate" style="font-size: 0.75rem; color: #9ca3af; margin-top: 5px;"></div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 20px; background: #f0f9ff; border-radius: 8px; border: 2px solid #3b82f6;">
                        <div class="stat-value" id="totalSignatures" style="font-size: 2.5rem; font-weight: bold; color: #1e40af;">0</div>
                        <div class="stat-label" style="color: #64748b; margin-top: 5px;">Total Firmas</div>
                    </div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 2px solid #10b981; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div id="repSignatureStatus" style="font-size: 1.8rem; font-weight: bold; color: #059669;">N/A</div>
                        <div style="color: #64748b; font-weight: 500;">Firma del Representante</div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button id="viewTodaySignaturesBtn" class="btn btn-primary" style="flex: 1; font-size: 0.95rem;">
                        Ver Firmas de Hoy
                    </button>
                    <button id="viewSignaturesBtn" class="btn btn-secondary" style="flex: 1; font-size: 0.95rem;">
                        Ver Todas
                    </button>
                </div>
                <button id="configRepBtn" class="btn btn-secondary" style="width: 100%;">
                    Configurar Firma del Representante
                </button>
            </div>
        </div>
        
        </div>

        <!-- Configuraci√≥n firma representante (Modal/Secci√≥n oculta) -->
        <div id="representantConfig" class="config-section" style="display: none; margin-top: 20px;">
            <div class="card" style="border: 2px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Firma del Representante Legal</h2>
                    <button onclick="document.getElementById('representantConfig').style.display='none'" 
                            class="btn btn-secondary" style="padding: 8px 16px;">
                        Cerrar
                    </button>
                </div>
                
                <div id="currentRepSignature" style="margin: 20px 0;"></div>
                
                <input type="file" id="repSignatureFile" accept="image/png,image/jpeg,image/jpg" style="display: none;">
                
                <div class="upload-area" id="repUploadArea" style="padding: 40px 20px; cursor: pointer;">
                    <div class="upload-content">
                        <div class="upload-icon" style="font-size: 3rem;">üìÑ</div>
                        <h4>Sube la imagen de la firma del representante</h4>
                        <p style="color: #64748b; margin-top: 10px;">Formatos: PNG, JPG o JPEG</p>
                    </div>
                </div>

                <div id="repSignaturePreview" style="display: none; margin: 20px 0; text-align: center;">
                    <h4>Vista Previa:</h4>
                    <img id="repPreviewImg" style="max-width: 300px; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                </div>

                <button id="saveRepBtn" class="btn btn-primary" style="width: 100%; margin-top: 15px; padding: 14px; font-size: 1.05rem;" disabled>
                    Guardar Firma del Representante
                </button>
            </div>
        </div>

        <!-- Lista de firmas registradas - Full Width -->
        <div class="card" id="signaturesListSection" style="display: none; grid-column: 1 / -1; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1.3rem;">Firmas Registradas</h3>
                <button id="closeSignaturesBtn" class="btn btn-secondary">Cerrar</button>
            </div>
            
            <!-- Filtros de b√∫squeda y fecha -->
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                <!-- B√∫squeda -->
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem;">
                        üîç Buscar:
                    </label>
                    <input type="text" id="searchInput" placeholder="Nombre o CURP..." 
                           style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;">
                </div>
                
                <!-- Filtro de fecha -->
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem;">
                        üìÖ Filtrar por fecha:
                    </label>
                    <input type="date" id="signaturesDateFilter" 
                           style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display: flex; gap: 8px; align-items: flex-end;">
                    <button id="searchBtn" class="btn btn-primary" style="padding: 10px 20px; white-space: nowrap;">
                        Buscar
                    </button>
                    <button id="clearFiltersBtn" class="btn btn-secondary" style="padding: 10px 20px; white-space: nowrap;">
                        Limpiar
                    </button>
                </div>
            </div>
            
            <!-- Contador de resultados -->
            <div id="signaturesCounter" style="margin-bottom: 15px; padding: 10px; background: #eff6ff; border-radius: 6px; border: 1px solid #3b82f6; display: none;">
                <span style="font-weight: 600; color: #1e40af;">Mostrando: </span>
                <span id="signaturesCountText" style="color: #3b82f6;">0 firmas</span>
            </div>
            
            <!-- Resultados de b√∫squeda espec√≠fica -->
            <div id="searchResults" style="display: none; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: #1f2937;">Resultados de b√∫squeda:</h3>
                <div id="searchResultsList" style="display: grid; gap: 15px;">
                    <!-- Resultados de b√∫squeda aqu√≠ -->
                </div>
            </div>
            
            <!-- Lista completa de firmas -->
            <div id="signaturesList" style="display: grid; gap: 15px;">
                <!-- Las firmas se cargar√°n aqu√≠ din√°micamente -->
            </div>
            
            <div id="noSignaturesMessage" style="display: none; text-align: center; padding: 50px; background: #f3f4f6; border-radius: 8px; border: 1px solid #e5e7eb;">
                <p style="font-size: 1.3rem; color: #6b7280; margin-bottom: 10px;">No hay firmas registradas</p>
                <p style="color: #9ca3af; font-size: 0.95rem;">Las firmas aparecer√°n aqu√≠ cuando se capturen desde la p√°gina de registro</p>
            </div>
        </div>

        <!-- Tabla de Cotejo de Asistencia - Full Width -->
        <div class="card" id="attendanceCheckSection" style="display: none; grid-column: 1 / -1; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1.3rem;">Tabla de Cotejo - Control de Asistencia</h3>
                <div style="display: flex; gap: 10px;">
                    <button id="filterAllBtn" class="btn btn-secondary" style="padding: 10px 20px;">
                        Todos
                    </button>
                    <button id="filterMissingBtn" class="btn btn-secondary" style="padding: 10px 20px; background: #ef4444; border-color: #ef4444;">
                        Solo Faltantes
                    </button>
                    <button id="closeAttendanceBtn" class="btn btn-secondary">
                        Cerrar
                    </button>
                </div>
            </div>

            <!-- Filtro de Gestor -->
            <div id="gestorFilterTable" style="display: none; margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #3b82f6;">
                <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <label for="gestorSelect" style="display: block; margin-bottom: 8px; font-weight: 600; color: #1f2937;">
                            üë• Filtrar por Gestor:
                        </label>
                        <select id="gestorSelect" style="width: 100%; padding: 12px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 1rem; background: white; cursor: pointer;">
                            <option value="TODOS">TODOS LOS GESTORES</option>
                        </select>
                    </div>
                    
                    <button id="loadConstanciasBtnInline" class="btn btn-secondary" style="padding: 12px 20px; white-space: nowrap; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2rem;">üìÇ</span>
                        <span id="loadConstanciasBtnText">Cargar Constancias</span>
                        <span id="constanciasCountInline" style="display: none; background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; margin-left: 4px;">0</span>
                    </button>
                    
                    <button id="printGestorBtn" class="btn btn-primary" style="padding: 12px 24px; white-space: nowrap;" disabled>
                        üñ®Ô∏è Imprimir Gestor Seleccionado
                    </button>
                    
                    <button id="exportMissingBtn" class="btn btn-secondary" style="padding: 12px 24px; white-space: nowrap; background: #f59e0b; border-color: #f59e0b; color: white;">
                        üì• Exportar Faltantes
                    </button>
                </div>
                
                <!-- Indicador de progreso de carga de constancias -->
                <div id="constanciasProgress" style="display: none; margin-top: 15px; padding: 15px; background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="width: 20px; height: 20px; border: 3px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span style="font-weight: 600; color: #1e40af;">Procesando constancias con OCR...</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">
                        <span id="constanciasProgressText">Escaneando archivo 0 de 0...</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: #dbeafe; border-radius: 4px; overflow: hidden;">
                        <div id="constanciasProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
            
            <style>
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            </style>
            
            <div style="overflow-x: auto;">
                <table id="attendanceTable" style="width: 100%; border-collapse: collapse; background: white;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #1f2937;">#</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #1f2937;">Nombre Completo</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #1f2937;">Gestor</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #1f2937;">Constancia</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #1f2937;">Estado Firma</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #1f2937;">Fecha y Hora de Firma</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #1f2937;">CURP</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #1f2937;">Constancia Impresa</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        <!-- Las filas se generar√°n din√°micamente -->
                    </tbody>
                </table>
            </div>
            
            <div id="noAttendanceMessage" style="display: none; text-align: center; padding: 50px; background: #fef3c7; border-radius: 8px; border: 1px solid #f59e0b; margin-top: 20px;">
                <p style="font-size: 1.3rem; color: #92400e; margin-bottom: 10px;">No hay lista de asistencia cargada</p>
                <p style="color: #78350f; font-size: 0.95rem;">Carga un archivo Excel con los nombres esperados para ver el cotejo</p>
            </div>
        </div>
    </div>

    <!-- Modal de Edici√≥n de Firma -->
    <div id="editSignatureModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 25px 0; color: #1f2937; font-size: 1.5rem;">‚úèÔ∏è Editar Datos de Firma</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Nombre Completo:</label>
                <input type="text" id="editFullName" style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
            </div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">CURP/RFC:</label>
                <input type="text" id="editDocument" style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 1rem;">
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancelEditBtn" class="btn btn-secondary" style="padding: 10px 20px;">Cancelar</button>
                <button id="saveEditBtn" class="btn btn-primary" style="padding: 10px 20px;">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>

    <footer style="margin-top: 40px; padding: 25px; background: #f8fafc; border-top: 2px solid #e2e8f0; text-align: center;">
        <p style="margin: 0; color: #64748b; font-size: 0.95rem;">
            Sistema de Firmas Digitales - CATRA | 
            <a href="index.html" style="color: #3b82f6; text-decoration: none; font-weight: 500;">Captura de Firmas</a>
        </p>
    </footer>

    <script src="admin.js"></script>
</body>
</html>
