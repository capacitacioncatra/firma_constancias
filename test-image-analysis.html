<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Diferencias en Im√°genes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .upload-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .image-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .image-box {
            flex: 1;
            min-width: 300px;
            border: 2px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        .image-box img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        .image-box canvas {
            max-width: 100%;
            height: auto;
            display: block;
            margin-top: 10px;
        }
        .stats {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 14px;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .stats-row:last-child {
            border-bottom: none;
        }
        .difference {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            color: #856404;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .comparison {
            margin-top: 20px;
            padding: 15px;
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            border-radius: 4px;
        }
        .comparison h3 {
            margin-top: 0;
            color: #0c5460;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        .histogram {
            margin-top: 10px;
        }
        .analysis-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç An√°lisis de Diferencias en Im√°genes</h1>
        
        <div class="upload-section">
            <h3>Cargar Im√°genes para Comparar</h3>
            <div>
                <label>Imagen 1 (que funciona):</label>
                <input type="file" id="file1" accept="image/*">
            </div>
            <div>
                <label>Imagen 2 (que NO funciona):</label>
                <input type="file" id="file2" accept="image/*">
            </div>
            <button onclick="analyzeImages()">Analizar Diferencias</button>
            <button onclick="testOCR()">Probar OCR en Ambas</button>
        </div>

        <div class="image-container" id="imageContainer"></div>
        <div id="comparisonResult"></div>
        <div id="ocrResult"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    <script>
        let image1Data = null;
        let image2Data = null;

        document.getElementById('file1').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadImage(file, 1);
            }
        });

        document.getElementById('file2').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadImage(file, 2);
            }
        });

        function loadImage(file, imageNumber) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    if (imageNumber === 1) {
                        image1Data = { img: img, file: file };
                    } else {
                        image2Data = { img: img, file: file };
                    }
                    console.log(`Imagen ${imageNumber} cargada:`, img.width, 'x', img.height);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function analyzeImages() {
            if (!image1Data || !image2Data) {
                alert('Por favor carga ambas im√°genes primero');
                return;
            }

            const container = document.getElementById('imageContainer');
            container.innerHTML = '';

            const analysis1 = analyzeImage(image1Data, 'Imagen 1 (Funciona)');
            const analysis2 = analyzeImage(image2Data, 'Imagen 2 (NO Funciona)');

            container.appendChild(analysis1.element);
            container.appendChild(analysis2.element);

            compareAnalysis(analysis1.stats, analysis2.stats);
        }

        function analyzeImage(imageData, title) {
            const { img, file } = imageData;
            
            const box = document.createElement('div');
            box.className = 'image-box';

            const titleEl = document.createElement('h3');
            titleEl.textContent = title;
            box.appendChild(titleEl);

            const imgEl = document.createElement('img');
            imgEl.src = img.src;
            box.appendChild(imgEl);

            // Crear canvas para an√°lisis
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            
            const imageData2 = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData2.data;

            // An√°lisis de p√≠xeles
            let totalBrightness = 0;
            let minBrightness = 255;
            let maxBrightness = 0;
            const histogram = new Array(256).fill(0);

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const brightness = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                
                totalBrightness += brightness;
                minBrightness = Math.min(minBrightness, brightness);
                maxBrightness = Math.max(maxBrightness, brightness);
                histogram[brightness]++;
            }

            const pixelCount = data.length / 4;
            const avgBrightness = totalBrightness / pixelCount;
            
            // Calcular contraste (desviaci√≥n est√°ndar)
            let variance = 0;
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const brightness = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                variance += Math.pow(brightness - avgBrightness, 2);
            }
            const stdDev = Math.sqrt(variance / pixelCount);

            // Calcular threshold OTSU
            const otsuThreshold = calculateOTSU(histogram, pixelCount);

            // Detectar si es escala de grises
            let isGrayscale = true;
            for (let i = 0; i < data.length; i += 4) {
                if (data[i] !== data[i + 1] || data[i + 1] !== data[i + 2]) {
                    isGrayscale = false;
                    break;
                }
            }

            const stats = {
                fileName: file.name,
                fileSize: file.size,
                fileType: file.type,
                width: img.width,
                height: img.height,
                pixels: pixelCount,
                avgBrightness: avgBrightness.toFixed(2),
                minBrightness: minBrightness,
                maxBrightness: maxBrightness,
                contrast: stdDev.toFixed(2),
                otsuThreshold: otsuThreshold,
                isGrayscale: isGrayscale,
                aspectRatio: (img.width / img.height).toFixed(3)
            };

            // Mostrar estad√≠sticas
            const statsDiv = document.createElement('div');
            statsDiv.className = 'stats';
            statsDiv.innerHTML = `
                <div class="stats-row"><span>Archivo:</span><span>${stats.fileName}</span></div>
                <div class="stats-row"><span>Tama√±o:</span><span>${(stats.fileSize / 1024).toFixed(2)} KB</span></div>
                <div class="stats-row"><span>Tipo:</span><span>${stats.fileType}</span></div>
                <div class="stats-row"><span>Dimensiones:</span><span>${stats.width} x ${stats.height}</span></div>
                <div class="stats-row"><span>Total p√≠xeles:</span><span>${stats.pixels.toLocaleString()}</span></div>
                <div class="stats-row"><span>Brillo promedio:</span><span>${stats.avgBrightness}</span></div>
                <div class="stats-row"><span>Rango brillo:</span><span>${stats.minBrightness} - ${stats.maxBrightness}</span></div>
                <div class="stats-row"><span>Contraste (œÉ):</span><span>${stats.contrast}</span></div>
                <div class="stats-row"><span>OTSU Threshold:</span><span>${stats.otsuThreshold}</span></div>
                <div class="stats-row"><span>Escala de grises:</span><span>${stats.isGrayscale ? 'S√≠' : 'No'}</span></div>
                <div class="stats-row"><span>Aspect Ratio:</span><span>${stats.aspectRatio}</span></div>
            `;
            box.appendChild(statsDiv);

            // Mostrar histograma
            const histCanvas = document.createElement('canvas');
            histCanvas.width = 256;
            histCanvas.height = 100;
            histCanvas.className = 'histogram';
            const histCtx = histCanvas.getContext('2d');
            drawHistogram(histCtx, histogram, pixelCount);
            box.appendChild(histCanvas);

            return { element: box, stats: stats, histogram: histogram };
        }

        function calculateOTSU(histogram, totalPixels) {
            let sum = 0;
            for (let i = 0; i < 256; i++) {
                sum += i * histogram[i];
            }

            let sumB = 0;
            let wB = 0;
            let wF = 0;
            let maxVariance = 0;
            let threshold = 0;

            for (let t = 0; t < 256; t++) {
                wB += histogram[t];
                if (wB === 0) continue;

                wF = totalPixels - wB;
                if (wF === 0) break;

                sumB += t * histogram[t];

                const mB = sumB / wB;
                const mF = (sum - sumB) / wF;

                const varianceBetween = wB * wF * (mB - mF) * (mB - mF);

                if (varianceBetween > maxVariance) {
                    maxVariance = varianceBetween;
                    threshold = t;
                }
            }

            return threshold;
        }

        function drawHistogram(ctx, histogram, totalPixels) {
            const maxCount = Math.max(...histogram);
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, 256, 100);
            
            ctx.fillStyle = '#007bff';
            for (let i = 0; i < 256; i++) {
                const height = (histogram[i] / maxCount) * 90;
                ctx.fillRect(i, 100 - height, 1, height);
            }
        }

        function compareAnalysis(stats1, stats2) {
            const resultDiv = document.getElementById('comparisonResult');
            
            let differences = [];

            if (stats1.width !== stats2.width || stats1.height !== stats2.height) {
                differences.push(`<strong>Dimensiones diferentes:</strong> ${stats1.width}x${stats1.height} vs ${stats2.width}x${stats2.height}`);
            }

            if (Math.abs(stats1.fileSize - stats2.fileSize) > 10000) {
                differences.push(`<strong>Tama√±o de archivo:</strong> ${(stats1.fileSize/1024).toFixed(2)}KB vs ${(stats2.fileSize/1024).toFixed(2)}KB (diferencia de ${Math.abs((stats1.fileSize - stats2.fileSize)/1024).toFixed(2)}KB)`);
            }

            if (Math.abs(parseFloat(stats1.avgBrightness) - parseFloat(stats2.avgBrightness)) > 5) {
                differences.push(`<strong>Brillo promedio:</strong> ${stats1.avgBrightness} vs ${stats2.avgBrightness}`);
            }

            if (Math.abs(parseFloat(stats1.contrast) - parseFloat(stats2.contrast)) > 5) {
                differences.push(`<strong>Contraste (desviaci√≥n est√°ndar):</strong> ${stats1.contrast} vs ${stats2.contrast}`);
            }

            if (Math.abs(stats1.otsuThreshold - stats2.otsuThreshold) > 10) {
                differences.push(`<strong>OTSU Threshold:</strong> ${stats1.otsuThreshold} vs ${stats2.otsuThreshold}`);
            }

            if (stats1.isGrayscale !== stats2.isGrayscale) {
                differences.push(`<strong>Espacio de color:</strong> ${stats1.isGrayscale ? 'Escala de grises' : 'Color'} vs ${stats2.isGrayscale ? 'Escala de grises' : 'Color'}`);
            }

            if (differences.length === 0) {
                resultDiv.innerHTML = `
                    <div class="comparison">
                        <h3>‚úÖ Las im√°genes son t√©cnicamente muy similares</h3>
                        <p>No se encontraron diferencias significativas en resoluci√≥n, brillo, contraste o espacio de color.</p>
                        <p><strong>Posibles causas del problema:</strong></p>
                        <ul>
                            <li>Diferencias m√≠nimas en compresi√≥n JPEG (artefactos)</li>
                            <li>Peque√±as variaciones en pixeles individuales</li>
                            <li>Orden de bytes o metadatos diferentes</li>
                            <li>Prueba el OCR en ambas para ver resultados espec√≠ficos</li>
                        </ul>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="comparison">
                        <h3>‚ö†Ô∏è Diferencias Encontradas</h3>
                        <ul>
                            ${differences.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                        <p><strong>Estas diferencias pueden afectar el OCR.</strong></p>
                    </div>
                `;
            }
        }

        async function testOCR() {
            if (!image1Data || !image2Data) {
                alert('Por favor carga ambas im√°genes primero');
                return;
            }

            const resultDiv = document.getElementById('ocrResult');
            resultDiv.innerHTML = '<div class="analysis-section"><h3>üîÑ Ejecutando OCR en ambas im√°genes...</h3><p>Esto puede tardar unos segundos...</p></div>';

            try {
                // OCR en imagen 1
                const result1 = await performOCR(image1Data.img, 'Imagen 1');
                
                // OCR en imagen 2
                const result2 = await performOCR(image2Data.img, 'Imagen 2');

                // Comparar resultados
                displayOCRResults(result1, result2);
            } catch (error) {
                resultDiv.innerHTML = `<div class="comparison" style="background: #f8d7da; border-left-color: #721c24;"><h3>‚ùå Error en OCR</h3><p>${error.message}</p></div>`;
            }
        }

        async function performOCR(img, label) {
            // Preprocesar imagen
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const preprocessed = preprocessImageForOCR(imageData);
            
            // OCR con Tesseract
            const { data } = await Tesseract.recognize(preprocessed.canvas, 'spa', {
                logger: m => console.log(label, m)
            });

            // Buscar nombre y CURP
            const text = data.text;
            const nameMatch = extractName(text);
            const curpMatch = extractCURP(text);

            return {
                label: label,
                fullText: text,
                name: nameMatch,
                curp: curpMatch,
                confidence: data.confidence
            };
        }

        function preprocessImageForOCR(imageData) {
            const canvas = document.createElement('canvas');
            canvas.width = imageData.width;
            canvas.height = imageData.height;
            const ctx = canvas.getContext('2d');
            
            const data = imageData.data;
            
            // Convertir a escala de grises
            for (let i = 0; i < data.length; i += 4) {
                const gray = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
                data[i] = data[i + 1] = data[i + 2] = gray;
            }
            
            // Aplicar OTSU
            const histogram = new Array(256).fill(0);
            for (let i = 0; i < data.length; i += 4) {
                histogram[data[i]]++;
            }
            
            const threshold = calculateOTSU(histogram, imageData.width * imageData.height);
            
            for (let i = 0; i < data.length; i += 4) {
                const value = data[i] > threshold ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = value;
            }
            
            ctx.putImageData(imageData, 0, 0);
            return { canvas: canvas, threshold: threshold };
        }

        function extractName(text) {
            const lines = text.split('\n');
            let foundConstancia = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.includes('CONSTANCIA') || line.includes('CAPACITACI√ìN')) {
                    foundConstancia = true;
                    continue;
                }
                
                if (foundConstancia) {
                    const words = line.split(/\s+/).filter(w => w.length > 2);
                    if (words.length >= 3 && words.length <= 5) {
                        if (words.every(w => /^[A-Z√Å√â√ç√ì√ö√ë]+$/.test(w))) {
                            return words.join(' ');
                        }
                    }
                }
            }
            return null;
        }

        function extractCURP(text) {
            const curpPattern = /[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[0-9A-Z]{2}/gi;
            const matches = text.match(curpPattern);
            return matches ? matches[0] : null;
        }

        function displayOCRResults(result1, result2) {
            const resultDiv = document.getElementById('ocrResult');
            
            const name1Success = result1.name ? '‚úÖ' : '‚ùå';
            const curp1Success = result1.curp ? '‚úÖ' : '‚ùå';
            const name2Success = result2.name ? '‚úÖ' : '‚ùå';
            const curp2Success = result2.curp ? '‚úÖ' : '‚ùå';

            resultDiv.innerHTML = `
                <div class="analysis-section">
                    <h3>üìä Resultados del OCR</h3>
                    
                    <div style="display: flex; gap: 20px; margin-top: 20px;">
                        <div style="flex: 1; padding: 15px; background: #e7f3ff; border-radius: 4px;">
                            <h4>${result1.label}</h4>
                            <p><strong>Nombre detectado:</strong> ${name1Success} ${result1.name || 'NO ENCONTRADO'}</p>
                            <p><strong>CURP detectado:</strong> ${curp1Success} ${result1.curp || 'NO ENCONTRADO'}</p>
                            <p><strong>Confianza OCR:</strong> ${result1.confidence.toFixed(2)}%</p>
                            <details>
                                <summary>Ver texto completo</summary>
                                <pre style="white-space: pre-wrap; font-size: 11px; max-height: 200px; overflow-y: auto;">${result1.fullText}</pre>
                            </details>
                        </div>
                        
                        <div style="flex: 1; padding: 15px; background: #fff3cd; border-radius: 4px;">
                            <h4>${result2.label}</h4>
                            <p><strong>Nombre detectado:</strong> ${name2Success} ${result2.name || 'NO ENCONTRADO'}</p>
                            <p><strong>CURP detectado:</strong> ${curp2Success} ${result2.curp || 'NO ENCONTRADO'}</p>
                            <p><strong>Confianza OCR:</strong> ${result2.confidence.toFixed(2)}%</p>
                            <details>
                                <summary>Ver texto completo</summary>
                                <pre style="white-space: pre-wrap; font-size: 11px; max-height: 200px; overflow-y: auto;">${result2.fullText}</pre>
                            </details>
                        </div>
                    </div>

                    <div class="comparison" style="margin-top: 20px;">
                        <h4>üîç An√°lisis Comparativo</h4>
                        ${generateComparison(result1, result2)}
                    </div>
                </div>
            `;
        }

        function generateComparison(result1, result2) {
            let analysis = '<ul>';
            
            const conf1 = result1.confidence;
            const conf2 = result2.confidence;
            
            if (Math.abs(conf1 - conf2) > 10) {
                analysis += `<li><strong>Confianza OCR:</strong> Diferencia de ${Math.abs(conf1 - conf2).toFixed(2)}% - La imagen ${conf1 > conf2 ? '1' : '2'} tiene mejor calidad para OCR</li>`;
            }
            
            if ((result1.name && !result2.name) || (!result1.name && result2.name)) {
                analysis += `<li><strong>Detecci√≥n de nombre:</strong> Solo funciona en ${result1.name ? 'Imagen 1' : 'Imagen 2'}</li>`;
            }
            
            if ((result1.curp && !result2.curp) || (!result1.curp && result2.curp)) {
                analysis += `<li><strong>Detecci√≥n de CURP:</strong> Solo funciona en ${result1.curp ? 'Imagen 1' : 'Imagen 2'}</li>`;
            }
            
            if (result1.name && result2.name && result1.name !== result2.name) {
                analysis += `<li><strong>Nombres diferentes detectados:</strong> "${result1.name}" vs "${result2.name}"</li>`;
            }
            
            if (result1.curp && result2.curp && result1.curp !== result2.curp) {
                analysis += `<li><strong>CURPs diferentes detectados:</strong> "${result1.curp}" vs "${result2.curp}"</li>`;
            }

            if (!result1.name && !result1.curp && !result2.name && !result2.curp) {
                analysis += `<li><strong>‚ùå Ambas im√°genes fallan:</strong> El OCR no puede detectar nombre ni CURP en ninguna de las dos</li>`;
                analysis += `<li><strong>Causa probable:</strong> La marca de agua y el bajo contraste afectan ambas im√°genes de igual manera</li>`;
            }

            analysis += '</ul>';
            
            if (result1.name || result1.curp || result2.name || result2.curp) {
                analysis += '<p><strong>Recomendaci√≥n:</strong> Usa la imagen con mayor tasa de detecci√≥n para referencias futuras.</p>';
            } else {
                analysis += '<p><strong>Recomendaci√≥n:</strong> Estas im√°genes necesitan mejor calidad (sin marca de agua, mayor contraste) para que el OCR funcione correctamente.</p>';
            }
            
            return analysis;
        }
    </script>
</body>
</html>
